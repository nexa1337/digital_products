
// Product Data
const productsData = {
  "templates-tools": [
    {
      id: 1,
      title: "SaaS Landing Page",
      author: "Design Studio",
      price: "$49.99",
      image: "/saas-template.jpg",
      images: [
        "/saas-template.jpg",
        "/saas-template-2.jpg",
        "/saas-template-3.jpg"
      ],
      tags: ["Popular"],
      description: "Modern SaaS landing page template.",
      features: [
        "Fully responsive design",
        "SEO optimized",
        "Easy customization",
        "Cross-browser compatibility"
      ],
      gumroadLink: "https://nexa1337.gumroad.com/l/?wanted=true"
    },
    {
      id: 2,
      title: "E-Commerce Store",
      author: "Web Creators",
      price: "$59.99",
      image: "/ecommerce-template.jpg",
      images: [
        "/ecommerce-template.jpg",
        "/ecommerce-template-2.jpg",
        "/ecommerce-template-3.jpg"
      ],
      tags: ["Trending"],
      description: "Complete e-commerce store template.",
      features: [
        "Shopping cart integration",
        "Payment gateway support",
        "Product management system",
        "Customer dashboard"
      ],
      gumroadLink: "https://nexa1337.gumroad.com/l/?wanted=true"
    },
    {
      id: 3,
      title: "Portfolio Website",
      author: "Creative Team",
      price: "$39.99",
      image: "/portfolio-template.jpg",
      images: [
        "/portfolio-template.jpg",
        "/portfolio-template-2.jpg",
        "/portfolio-template-3.jpg"
      ],
      tags: ["New"],
      description: "Professional portfolio template.",
      features: [
        "Project showcase gallery",
        "Contact form integration",
        "Social media links",
        "Print-friendly layout"
      ],
      gumroadLink: "https://nexa1337.gumroad.com/l/?wanted=true"
    }
  ],
  "digital-design-assets": [
    {
      id: 1,
      title: "UI Kit Bundle",
      author: "Design Studio",
      price: "$29.99",
      image: "/ui-kit.jpg",
      images: [
        "/ui-kit.jpg",
        "/ui-kit-2.jpg",
        "/ui-kit-3.jpg"
      ],
      tags: ["Popular"],
      description: "Complete UI kit with over 500 components.",
      features: [
        "500+ UI components",
        "Figma and Sketch files",
        "Fully customizable",
        "Regular updates"
      ],
      gumroadLink: "https://nexa1337.gumroad.com/l/?wanted=true"
    },
    {
      id: 2,
      title: "Icon Pack Pro",
      author: "Icon Masters",
      price: "$19.99",
      image: "/icon-pack.jpg",
      images: [
        "/icon-pack.jpg",
        "/icon-pack-2.jpg",
        "/icon-pack-3.jpg"
      ],
      tags: ["Trending"],
      description: "Professional SVG icon collection.",
      features: [
        "1000+ vector icons",
        "Multiple color variations",
        "SVG and PNG formats",
        "Commercial license included"
      ],
      gumroadLink: "https://nexa1337.gumroad.com/l/?wanted=true"
    }
  ],
  "ai-prompts-automation": [
    {
      id: 1,
      title: "Content Writing Pack",
      author: "AI Experts",
      price: "$24.99",
      image: "/content-pack.jpg",
      images: [
        "/content-pack.jpg",
        "/content-pack-2.jpg",
        "/content-pack-3.jpg"
      ],
      tags: ["Popular"],
      description: "Complete AI content writing prompt collection.",
      features: [
        "100+ writing prompts",
        "Copywriting templates",
        "Social media content",
        "Email marketing templates"
      ],
      gumroadLink: "https://nexa1337.gumroad.com/l/?wanted=true"
    },
    {
      id: 2,
      title: "Automation Scripts",
      author: "Automation Pro",
      price: "$34.99",
      image: "/automation-scripts.jpg",
      images: [
        "/automation-scripts.jpg",
        "/automation-scripts-2.jpg",
        "/automation-scripts-3.jpg"
      ],
      tags: ["New"],
      description: "Time-saving automation scripts pack.",
      features: [
        "15+ automation scripts",
        "Cross-platform compatibility",
        "Detailed documentation",
        "Lifetime updates"
      ],
      gumroadLink: "https://nexa1337.gumroad.com/l/?wanted=true"
    }
  ],
  "courses-guides": [
    {
      id: 1,
      title: "The Self-Taught Cybersecurity Navigator",
      author: "Mr Marouan Anouar",
      price: "$29.99",
      image: "https://public-files.gumroad.com/f1uaqtct37x4gl3i62yz3u6dhsnf",
      images: [
        "https://public-files.gumroad.com/41fr6yxhrw2f8fh0eigm8etym0c2",
        "",
        ""
      ],
      tags: ["Cybersecurity", "New"],
      description: "Your complete guide to a cybersecurity career. Learn Red Team, Blue Team, and Bug Bounty with practical labs and a step-by-step roadmap for beginners.",
      features: [
        "Size : 9MB",
        "Length : 109 pages"
      ],
      gumroadLink: "https://nexa1337.gumroad.com/l/TheSelf-TaughtCybersecurityNavigator?wanted=true"
    },
    {
      id: 2,
      title: "JavaScript Advanced",
      author: "Sarah Johnson",
      price: "$24.99",
      image: "/javascript-book.jpg",
      images: [
        "/javascript-book.jpg",
        "/javascript-book-2.jpg",
        "/javascript-book-3.jpg"
      ],
      tags: ["Trending"],
      description: "Master advanced JavaScript concepts and patterns.",
      features: [
        "Advanced ES6+ features",
        "Functional programming",
        "Performance optimization",
        "Real-world examples"
      ],
      gumroadLink: "https://nexa1337.gumroad.com/l/?wanted=true"
    }
  ],
  "service-offers": [
    {
      id: 1,
      title: "Website Audit Service",
      author: "Web Experts",
      price: "$99.99",
      image: "/website-audit.jpg",
      images: [
        "/website-audit.jpg",
        "/website-audit-2.jpg",
        "/website-audit-3.jpg"
      ],
      tags: ["Popular"],
      description: "Comprehensive website performance and SEO audit.",
      features: [
        "Performance analysis",
        "SEO optimization report",
        "Security assessment",
        "Actionable recommendations"
      ],
      gumroadLink: "https://nexa1337.gumroad.com/l/?wanted=true"
    }
  ],
  "data-research": [
    {
      id: 1,
      title: "Market Research Bundle",
      author: "Data Insights",
      price: "$49.99",
      image: "/market-research.jpg",
      images: [
        "/market-research.jpg",
        "/market-research-2.jpg",
        "/market-research-3.jpg"
      ],
      tags: ["Trending"],
      description: "Comprehensive market research data package.",
      features: [
        "Industry analysis reports",
        "Competitor research data",
        "Consumer behavior insights",
        "Excel and CSV formats"
      ],
      gumroadLink: "https://nexa1337.gumroad.com/l/?wanted=true"
    }
  ]
}

const currentPage = {}
const currentFilter = {}
let searchQuery = ""
let isDarkMode = localStorage.getItem("darkMode") === "true"
const ITEMS_PER_PAGE = 6

let visitorCount = Number.parseInt(localStorage.getItem("visitors") || "1250")
let visitorUpdateInterval
const debugMode = document.body.getAttribute("data-debug-visitors") || "normal"

// Initialize
document.addEventListener("DOMContentLoaded", () => {
  initializeDarkMode()
  initializePopup()
  initializeDateTime()
  initializeVisitorCounter()
  initializeSearch()
  initializeProducts()
  initializeScrollToTop()
  initializeHamburger()
  initializeNavbarScroll()
  initializeSnow()
  handleHashNavigation()
  window.addEventListener("hashchange", handleHashNavigation)
})

// Snow animation
function initializeSnow() {
  const snowContainer = document.getElementById("snow-container")
  const snowflakeCount = 50

  for (let i = 0; i < snowflakeCount; i++) {
    const snowflake = document.createElement("div")
    snowflake.classList.add("snowflake")
    snowflake.textContent = "â„"

    // Random horizontal position
    const randomLeft = Math.random() * 100
    snowflake.style.left = randomLeft + "%"

    // Random animation duration (8-15 seconds)
    const duration = Math.random() * 7 + 8
    snowflake.style.animationDuration = duration + "s"

    // Random animation delay
    const delay = Math.random() * 5
    snowflake.style.animationDelay = delay + "s"

    // Random opacity (0.5-1)
    snowflake.style.opacity = Math.random() * 0.5 + 0.5

    // Random font size (0.8em - 1.5em)
    snowflake.style.fontSize = Math.random() * 0.7 + 0.8 + "em"

    snowContainer.appendChild(snowflake)
  }
}

// Dark Mode
function initializeDarkMode() {
  if (isDarkMode) {
    document.body.classList.add("dark-mode")
    updateThemeIcon()
  }

  document.getElementById("theme-toggle").addEventListener("click", () => {
    isDarkMode = !isDarkMode
    document.body.classList.toggle("dark-mode")
    localStorage.setItem("darkMode", isDarkMode)
    updateThemeIcon()
  })
}

function updateThemeIcon() {
  const icon = document.querySelector(".theme-icon")
  icon.textContent = isDarkMode ? "â˜€ï¸" : "ðŸŒ™"
}

// Popup Modal
function initializePopup() {
  const popupModal = document.getElementById("popup-modal")
  const popupClose = document.querySelector(".popup-close")
  const popupDontShow = document.getElementById("popup-dont-show")
  const popupLinks = document.querySelectorAll(".popup-link")
  const popupContent = document.querySelector(".popup-content")

  const popupDismissed = localStorage.getItem("nexa_popup_dismissed")

  if (!popupDismissed) {
    // Show popup after 2.5 seconds on first visit
    setTimeout(() => {
      showPopup()
    }, 2500)

    // Also show on exit intent (mouse leaves viewport)
    document.addEventListener("mouseleave", (e) => {
      if (e.clientY <= 0 && !localStorage.getItem("nexa_popup_dismissed")) {
        showPopup()
      }
    })
  }

  function showPopup() {
    popupModal.classList.remove("hidden")
    document.body.classList.add("popup-open")
    popupClose.focus()
    setupFocusTrap(popupContent)
  }

  function closePopup() {
    popupModal.classList.add("hidden")
    document.body.classList.remove("popup-open")

    if (popupDontShow.checked) {
      localStorage.setItem("nexa_popup_dismissed", "1")
    }
  }

  // Close button
  popupClose.addEventListener("click", closePopup)

  // Overlay click
  document.querySelector(".popup-overlay").addEventListener("click", closePopup)

  // ESC key to close
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !popupModal.classList.contains("hidden")) {
      closePopup()
    }
  })

  // Links close popup if they're internal
  popupLinks.forEach((link) => {
    link.addEventListener("click", (e) => {
      if (link.getAttribute("href").startsWith("#")) {
        closePopup()
      }
    })
  })
}

// Focus trap for modal
function setupFocusTrap(element) {
  const focusableElements = element.querySelectorAll('button, [href], input, [tabindex]:not([tabindex="-1"])')
  const firstElement = focusableElements[0]
  const lastElement = focusableElements[focusableElements.length - 1]

  element.addEventListener("keydown", (e) => {
    if (e.key === "Tab") {
      if (e.shiftKey) {
        if (document.activeElement === firstElement) {
          e.preventDefault()
          lastElement.focus()
        }
      } else {
        if (document.activeElement === lastElement) {
          e.preventDefault()
          firstElement.focus()
        }
      }
    }
  })
}

// Date and Time
function initializeDateTime() {
  function updateDateTime() {
    const now = new Date()
    const dateStr = now.toLocaleDateString("en-US", {
      weekday: "short",
      month: "short",
      day: "numeric",
      year: "numeric",
    })
    const timeStr = now.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", second: "2-digit" })

    document.getElementById("current-date").textContent = dateStr
    document.getElementById("current-time").textContent = timeStr
  }

  updateDateTime()
  setInterval(updateDateTime, 1000)
}

function initializeVisitorCounter() {
  updateVisitorDisplay()
  startVisitorUpdates()
}

function updateVisitorDisplay() {
  const countElement = document.getElementById("visitor-count")
  const dot = document.getElementById("visitor-dot")

  countElement.textContent = visitorCount

  // Update dot color based on visitor count
  if (visitorCount < 50) {
    dot.classList.add("low-activity")
    dot.classList.remove("decreasing")
  } else {
    dot.classList.remove("low-activity")
  }
}

function startVisitorUpdates() {
  visitorUpdateInterval = setInterval(
    () => {
      const oldCount = visitorCount

      // Weighted probability for spike simulation
      let targetCount
      const rand = Math.random()

      if (debugMode === "spike") {
        // Force spike mode for QA
        targetCount = Math.floor(Math.random() * 10000) + 15000
      } else if (rand < 0.9) {
        // 90% normal range (300-3000)
        targetCount = Math.floor(Math.random() * 2700) + 300
      } else if (rand < 0.98) {
        // 8% medium spike (10k-20k)
        targetCount = Math.floor(Math.random() * 10000) + 10000
      } else {
        // 2% large spike (25k-35k)
        targetCount = Math.floor(Math.random() * 10000) + 25000
      }

      // Smooth transition to target
      const delta = Math.sign(targetCount - visitorCount) * Math.ceil(Math.abs(targetCount - visitorCount) / 5)
      visitorCount = Math.max(1, visitorCount + delta)

      // Animate the number change
      animateCounter(oldCount, visitorCount)

      // Update dot animation based on increase/decrease
      const dot = document.getElementById("visitor-dot")
      if (visitorCount > oldCount) {
        dot.classList.remove("decreasing")
        dot.style.animation = "none"
        setTimeout(() => {
          dot.style.animation = "pulse 2s infinite"
        }, 10)
      } else if (visitorCount < oldCount) {
        dot.classList.add("decreasing")
        dot.style.animation = "none"
        setTimeout(() => {
          dot.style.animation = "pulse-dim 2s infinite"
        }, 10)
      }

      localStorage.setItem("visitors", visitorCount)
    },
    Math.random() * 4000 + 3000,
  ) // 3-7 seconds
}

function animateCounter(start, end) {
  const countElement = document.getElementById("visitor-count")
  const duration = 600 // 600ms animation
  const startTime = Date.now()

  function update() {
    const elapsed = Date.now() - startTime
    const progress = Math.min(elapsed / duration, 1)
    const current = Math.floor(start + (end - start) * progress)
    countElement.textContent = current

    if (progress < 1) {
      requestAnimationFrame(update)
    }
  }

  update()
}

// Search Functionality
function initializeSearch() {
  const searchInput = document.getElementById("search-input")
  const searchBtn = document.querySelector(".search-btn")

  function performSearch() {
    searchQuery = searchInput.value.toLowerCase()
    Object.keys(productsData).forEach((category) => {
      currentPage[category] = 1
    })
    renderAllProducts()
  }

  searchInput.addEventListener("input", performSearch)
  searchBtn.addEventListener("click", performSearch)
  searchInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") performSearch()
  })
}

function initializeProducts() {
  Object.keys(productsData).forEach((category) => {
    currentPage[category] = 1
    currentFilter[category] = "all"
    renderProducts(category)
  })

  // Tab buttons
  setupTabEventListeners()
}

function setupTabEventListeners() {
  document.querySelectorAll(".tab-btn").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      const tabContainer = e.target.closest(".category-tabs")
      const section = tabContainer.closest(".products-section")
      const category = section ? section.id : null
      const filter = e.target.dataset.filter

      if (category && productsData[category]) {
        // Remove active class from all tabs in this section
        tabContainer.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"))
        // Add active class to clicked tab
        e.target.classList.add("active")

        currentFilter[category] = filter
        currentPage[category] = 1
        renderProducts(category)
      }
    })
  })
}

function handleHashNavigation() {
  const hash = window.location.hash.slice(1)
  if (!hash) return

  const match = hash.match(/^(\w+)-page-(\d+)$/)
  if (match) {
    const [, category, page] = match
    if (productsData[category]) {
      currentPage[category] = Number.parseInt(page)
      renderProducts(category)
      setTimeout(() => {
        document.getElementById(category).scrollIntoView({ behavior: "smooth" })
      }, 100)
    }
  }
}

function renderProducts(category) {
  const grid = document.getElementById(`${category}-grid`)
  const pagination = document.getElementById(`${category}-pagination`)

  let products = productsData[category]

  // Apply search filter
  if (searchQuery) {
    products = products.filter(
      (p) =>
        p.title.toLowerCase().includes(searchQuery) ||
        p.author.toLowerCase().includes(searchQuery) ||
        p.description.toLowerCase().includes(searchQuery),
    )
  }

  // Apply category filter
  if (currentFilter[category] !== "all") {
    products = products.filter((p) => p.tags.includes(currentFilter[category]))
  }

  const totalPages = Math.ceil(products.length / ITEMS_PER_PAGE)
  const startIdx = (currentPage[category] - 1) * ITEMS_PER_PAGE
  const paginatedProducts = products.slice(startIdx, startIdx + ITEMS_PER_PAGE)

  // Show loading shimmer
  grid.classList.add("loading")

  setTimeout(() => {
    // Render grid
    grid.innerHTML = paginatedProducts
      .map(
        (product) => `
          <div class="product-card">
              ${product.image ? 
                `<img src="${product.image}" alt="${product.title}" class="product-image" loading="lazy">` : 
                `<div class="product-image">
                  <div class="product-image-placeholder">
                    <span>${product.title.charAt(0)}</span>
                  </div>
                </div>`
              }
              <div class="product-info">
                  <h3 class="product-title">${product.title}</h3>
                  <p class="product-author">by ${product.author}</p>
                  <div class="product-tags">
                      ${product.tags.map((tag) => `<span class="product-tag">${tag}</span>`).join("")}
                  </div>
                  <div class="product-footer">
                      <span class="product-price">${product.price}</span>
                  </div>
                  <button class="quick-view-btn" onclick="openQuickView(${product.id}, '${category}')" aria-label="Quick view ${product.title}">Quick View</button>
              </div>
          </div>
      `,
      )
      .join("")

    grid.classList.remove("loading")

    // Render pagination
    pagination.innerHTML = ""
    if (totalPages > 1) {
      // Prev button
      if (currentPage[category] > 1) {
        const prevBtn = document.createElement("button")
        prevBtn.className = "pagination-btn"
        prevBtn.textContent = "Prev"
        prevBtn.addEventListener("click", () => {
          currentPage[category]--
          window.location.hash = `${category}-page-${currentPage[category]}`
        })
        pagination.appendChild(prevBtn)
      }

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button")
        btn.className = `pagination-btn ${i === currentPage[category] ? "active" : ""}`
        btn.textContent = i
        btn.setAttribute("aria-label", `Go to page ${i}`)
        btn.addEventListener("click", () => {
          window.location.hash = `${category}-page-${i}`
        })
        pagination.appendChild(btn)
      }

      // Next button
      if (currentPage[category] < totalPages) {
        const nextBtn = document.createElement("button")
        nextBtn.className = "pagination-btn"
        nextBtn.textContent = "Next"
        nextBtn.addEventListener("click", () => {
          currentPage[category]++
          window.location.hash = `${category}-page-${currentPage[category]}`
        })
        pagination.appendChild(nextBtn)
      }
    }
  }, 250) // 250ms loading shimmer
}

function renderAllProducts() {
  Object.keys(productsData).forEach((category) => {
    renderProducts(category)
  })
}

// Quick View Modal
function openQuickView(productId, category) {
  const product = productsData[category].find((p) => p.id === productId)
  if (!product) return

  // Set main image
  document.getElementById("qv-image").src = product.image
  document.getElementById("qv-title").textContent = product.title
  document.getElementById("qv-author").textContent = `by ${product.author}`
  
  // Create description with features list if available
  let descriptionHTML = `<p>${product.description}</p>`
  if (product.features && product.features.length > 0) {
    descriptionHTML += `
      <h4>What's Included:</h4>
      <ul class="qv-features-list">
        ${product.features.map(feature => `<li>${feature}</li>`).join('')}
      </ul>
    `
  }
  
  document.getElementById("qv-description").innerHTML = descriptionHTML
  document.getElementById("qv-price").textContent = product.price
  document.getElementById("qv-tags").innerHTML = product.tags
    .map((tag) => `<span class="qv-tag">${tag}</span>`)
    .join("")
  document.getElementById("qv-buy-btn").href = product.gumroadLink || `https://gumroad.com/search?search=${encodeURIComponent(product.title)}`

  // Handle multiple images if available
  const thumbnailsContainer = document.getElementById("qv-thumbnails");
  if (product.images && product.images.length > 1) {
    thumbnailsContainer.innerHTML = product.images.map((img, index) => 
      `<img src="${img}" alt="Product image ${index + 1}" class="${index === 0 ? 'active' : ''}" data-src="${img}">`
    ).join('');
    
    // Add click event listeners to thumbnails
    thumbnailsContainer.querySelectorAll('img').forEach((thumb, index) => {
      thumb.addEventListener('click', () => {
        // Update main image
        document.getElementById("qv-image").src = product.images[index];
        
        // Update active thumbnail
        thumbnailsContainer.querySelectorAll('img').forEach(t => t.classList.remove('active'));
        thumb.classList.add('active');
      });
    });
  } else {
    thumbnailsContainer.innerHTML = '';
  }

  document.getElementById("quick-view-modal").classList.add("active")
  document.body.classList.add("popup-open")
}

document.querySelector(".quick-view-close").addEventListener("click", () => {
  document.getElementById("quick-view-modal").classList.remove("active")
  document.body.classList.remove("popup-open")
})

document.querySelector(".quick-view-overlay").addEventListener("click", () => {
  document.getElementById("quick-view-modal").classList.remove("active")
  document.body.classList.remove("popup-open")
})

// Scroll to Top
function initializeScrollToTop() {
  const scrollBtn = document.getElementById("scroll-to-top")

  window.addEventListener("scroll", () => {
    if (window.scrollY > 300) {
      scrollBtn.classList.add("visible")
    } else {
      scrollBtn.classList.remove("visible")
    }
  })

  scrollBtn.addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: "smooth" })
  })
}

// Hamburger Menu
function initializeHamburger() {
  const hamburger = document.getElementById("hamburger")
  const navMenu = document.getElementById("navbar-menu")

  hamburger.addEventListener("click", () => {
    navMenu.classList.toggle("active")
  })

  document.querySelectorAll(".nav-link").forEach((link) => {
    link.addEventListener("click", () => {
      navMenu.classList.remove("active")
    })
  })
}

// Navbar Scroll
function initializeNavbarScroll() {
  const navbar = document.querySelector(".navbar")

  window.addEventListener("scroll", () => {
    if (window.scrollY > 100) {
      navbar.classList.add("scrolled")
    } else {
      navbar.classList.remove("scrolled")
    }
  })
}
